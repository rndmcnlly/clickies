<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Album Capturer</title>

  <link rel="stylesheet" href="album-style.css">

  <script src="libv86.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@3.1.1/dist.umd/msgpack.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fast-json-patch@3.1.1/dist/fast-json-patch.min.js"></script>

  <script src="../savestreams_updated.js"></script>

  <script src="album_capturer.js"></script>
</head>
<body>

<script>
  "use strict";

  window.onload = function () {
    const statusLabel = document.getElementById("status");
    let emulator = null;
    let capturer = null;

    // 0. Check Dependencies
    if (typeof V86 === 'undefined') {
        statusLabel.textContent = "Error: V86 library not loaded.";
        statusLabel.style.color = "red";
        return;
    }
    if (typeof AlbumCapturer === 'undefined') {
        statusLabel.textContent = "Error: AlbumCapturer library not loaded.";
        statusLabel.style.color = "red";
        return;
    }

    // 1. Define emulator specs
    let specs = {
      wasm_path: "../assets/v86.wasm",
      memory_size: 32 * 1024 * 1024,
      vga_memory_size: 2 * 1024 * 1024,
      screen_container: document.getElementById("screen_container"),
      bios: {
        url: "../assets/seabios.bin.file",
      },
      vga_bios: {
        url: "../assets/vgabios.bin.file",
      },
      cdrom: {
        url: "../assets/dsl-4.11.rc2.iso.file",
      },
      autostart: true,
      initial_state: {
        url: "../assets/v86state-dsl.bin.file",
      },
    };

    // 2. Initialize Emulator with Error Handling
    try {
        statusLabel.textContent = "Initializing Emulator...";
        
        emulator = window.emulator = new V86(specs);

        // --- GLOBAL ERROR LISTENER ---
        emulator.add_listener("emulator-error", (error) => {
            console.error("EMULATOR ERROR:", error);
            statusLabel.textContent = `Emulator Error: ${error.message || "Check console"}`;
            statusLabel.style.color = "red";
        });

    } catch (e) {
        console.error("V86 Initialization Error:", e);
        statusLabel.textContent = `Init Failed: ${e.message}`;
        statusLabel.style.color = "red";
        return;
    }

    // Mouse Lock Support
    const screen_container = document.getElementById("screen_container");
    screen_container.addEventListener("click", () => {
        if (emulator) {
            scaleInput.blur();
            emulator.lock_mouse();
        }
    });

    // 3. Initialize AlbumCapturer
    capturer = new AlbumCapturer(emulator, specs);

    // 4. Get UI elements
    let saveButton = document.getElementById("save");
    let recordButton = document.getElementById("record");
    
    // 5. Handle Scale Input
    let scaleInput = document.getElementById("scaleInput");
    let playerWrapper = document.getElementById("player-wrapper");
    let controlsWrapper = document.getElementById("controls");
    let instructionsWrapper = document.getElementById("instructions");
    let browserWarning = document.getElementById("browser-warning");

    scaleInput.addEventListener("input", () => {
        const widthVal = scaleInput.value + "%";
        playerWrapper.style.width = widthVal;
        controlsWrapper.style.width = widthVal;
        instructionsWrapper.style.width = widthVal;
        browserWarning.style.width = widthVal;

        if (scaleInput.value > 80) {
            playerWrapper.style.maxWidth = "none";
            controlsWrapper.style.maxWidth = "none";
            instructionsWrapper.style.maxWidth = "none";
            browserWarning.style.maxWidth = "none";
        }
    });

    // 6. Main Logic: Status Updates
    emulator.add_listener("emulator-ready", function () {
      console.log("EVENT: emulator-ready");
      statusLabel.textContent = "Emulator Initialized. Booting...";
    });
    
    emulator.add_listener("emulator-loaded", async function () {
      console.log("EVENT: emulator-loaded");
      statusLabel.textContent = "Emulator Running. Setting up recorder...";
      
      try {
          const canvas = document.getElementById("emulator-canvas");
      // Initialize the capturer (fetches scancodes, etc.)
          await capturer.init(canvas);

          // Set initial scale
          scaleInput.dispatchEvent(new Event('input'));
          
          // Final Status Update
          statusLabel.textContent = "Ready. Select an album folder to begin.";
          statusLabel.style.color = "#28a745"; // Green for ready

          // --- Create/Open Album Button ---
          saveButton.addEventListener("click", async () => {
        console.log("Creating album...")
            saveButton.blur();
            statusLabel.textContent = "Select a folder...";
            statusLabel.style.color = "#666";
            
            const success = await capturer.createAlbum();
            
            if (success) {
              saveButton.disabled = true;
              saveButton.value = "üìÇ Album Open";
              recordButton.disabled = false;
              statusLabel.textContent = "Ready to record.";
          console.log("Album created/opened.");
            } else {
              statusLabel.textContent = "Album selection cancelled.";
            }
          });

          // --- Start/Stop Recording Button ---
          recordButton.addEventListener("click", async () => {
        recordButton.blur(); // Remove focus so Spacebar works in emulator
            
            if (capturer.isRecording) {
          console.log("Stopping recording...");
              recordButton.disabled = true;
              recordButton.classList.remove("recording");
              recordButton.value = "‚è≥ Finalizing clickie (may take >1 min)...";
              statusLabel.textContent = "Encoding video & compressing states. Please wait...";

                // --- DEFINE UI CALLBACK ---
                const onProgress = (current, total) => {
                    const percent = Math.round((current / total) * 100);
                    statusLabel.textContent = `Compressing state ${current} of ${total} (${percent}%)`;
                    statusLabel.style.color = "#e67e22"; // Orange color
                };
              
              await capturer.stopRecording(onProgress);
              
              recordButton.disabled = false;
              recordButton.value = "üî¥ Start Recording Another Clip";
          statusLabel.textContent = "Clickie saved! Ready for next.";
          console.log("Recording stopped and clickie finalized.");
              
            } else {
              // STARTING
              statusLabel.textContent = "Recording... (Click screen to capture mouse)";
              statusLabel.style.color = "#dc3545"; // Red recording color
              await capturer.startRecording();
              recordButton.value = "‚èπ Stop Recording";
              recordButton.classList.add("recording");
            }
          });

      } catch (err) {
          console.error("Setup Error:", err);
          statusLabel.textContent = "Error setting up recorder: " + err.message;
          statusLabel.style.color = "red";
      }
    });
  };
</script>

<div id="browser-warning">
    <strong>‚ö†Ô∏è Browser Compatibility Warning:</strong> This application requires the 
    <code>window.showDirectoryPicker</code> API (File System Access), which is not supported in your current browser. 
    <br>
    Please use a desktop version of <strong>Chrome, Edge, or Opera</strong>.
    <br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker" target="_blank">Learn more at MDN</a>.
</div>

<h1>Album Capturer</h1>

<div id="instructions">
    <h3>Instructions & Tips</h3>
    <ul>
        <li><strong>Step 1:</strong> Click <em>"Create/Open Album Folder"</em> to select an empty folder for your recordings.</li>
        <li><strong>Step 2:</strong> Click <em>"Start Recording Clip"</em> to begin capturing video, inputs, and machine states.</li>
        <li><strong>Step 3:</strong> Interact with the VM! Click the screen to lock your mouse. Press <strong>ESC</strong> to unlock.</li>
        <li><strong>Step 4:</strong> Click <em>"Stop Recording"</em> when finished.</li>
        <li><strong>‚ö†Ô∏è Note:</strong> Finalizing a clip involves heavy compression. It <strong>may take over a minute</strong> for long clips. The browser might freeze briefly.</li>
    </ul>
</div>

<div id="player-wrapper">
    <div id="screen_container" class="capturer-visible">
        <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
        <canvas id="emulator-canvas"></canvas>
    </div>
</div>

<div id="controls">
  <input id="save" type="button" value="üìÇ Create/Open Album Folder" />
  <input id="record" type="button" value="üî¥ Start Recording Clip" disabled />
  
  <div style="flex-grow: 1;"></div> <label style="font-weight: bold; color: #555; margin-left: 10px;">Scale:</label>
  <input id="scaleInput" type="number" value="80" min="10" max="200" style="width: 50px; padding: 5px; border-radius: 5px; border: 1px solid #ccc;" />
  <span style="color: #555;">%</span>

  <span id="status">Waiting for emulator...</span>
</div>

<script>
    // Check for File System Access API support
    if (!('showDirectoryPicker' in window)) {
        document.getElementById('browser-warning').style.display = 'block';
    }
</script>

</body>
</html>