<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Album Capturer</title>

  <link rel="stylesheet" href="album-style.css">

  <script src="libv86.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@3.1.1/dist/umd/msgpack.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fast-json-patch@3.1.1/dist/fast-json-patch.min.js"></script>

  <script src="../savestreams_updated.js"></script>

  <script src="album_capturer.js"></script>
</head>
<body>

<script>
  "use strict";

  window.onload = function () {
    // 1. Define emulator specs
    let specs = {
      wasm_path: "../assets/v86.wasm",
      memory_size: 32 * 1024 * 1024,
      vga_memory_size: 2 * 1024 * 1024,
      screen_container: document.getElementById("screen_container"),
      bios: {
        url: "../assets/seabios.bin.file",
      },
      vga_bios: {
        url: "../assets/vgabios.bin.file",
      },
      cdrom: {
        url: "../assets/dsl-4.11.rc2.iso.file",
      },
      autostart: true,
      initial_state: {
        url: "../assets/v86state-dsl.bin.file",
      },
    };

    // 2. Initialize emulator
    var emulator = (window.emulator = new V86(specs));

    // add click-to-lock for mouse
    const screen_container = document.getElementById("screen_container");
    screen_container.addEventListener("click", () => {
        if (emulator) {
            emulator.lock_mouse();
        }
    });

    // 3. Initialize AlbumCapturer
    const capturer = new AlbumCapturer(emulator, specs);

    // 4. Get UI elements
    let saveButton = document.getElementById("save");
    let recordButton = document.getElementById("record");
    let statusLabel = document.getElementById("status");

// --- NEW: Handle Scale Input ---
    let scaleInput = document.getElementById("scaleInput");
    let playerWrapper = document.getElementById("player-wrapper");

    scaleInput.addEventListener("change", () => {
        // Update the width of the container based on the percentage
        playerWrapper.style.width = scaleInput.value + "%";
        // Optional: Remove max-width to allow it to go as huge as possible
        playerWrapper.style.maxWidth = "none"; 
    });
    
    // 5. Wire up UI after emulator loads
    emulator.bus.register("emulator-loaded", async function () {
      const canvas = document.getElementById("emulator-canvas");
      // Initialize the capturer (fetches scancodes, etc.)
      await capturer.init(canvas);

      // --- Create/Open Album Button ---
      saveButton.addEventListener("click", async () => {
        console.log("Creating album...")
        saveButton.blur();
        statusLabel.textContent = "Select a folder...";
        
        const success = await capturer.createAlbum();
        
        if (success) {
          saveButton.disabled = true;
          saveButton.value = "üìÇ Album Open";
          recordButton.disabled = false;
          statusLabel.textContent = "Ready to record.";
          console.log("Album created/opened.");
        } else {
          statusLabel.textContent = "Album selection cancelled.";
        }
      });

      // --- Start/Stop Recording Button ---
      recordButton.addEventListener("click", async () => {
        recordButton.blur(); // Remove focus so Spacebar works in emulator
        
        if (capturer.isRecording) {
          console.log("Stopping recording...");
          recordButton.disabled = true;
          recordButton.classList.remove("recording");
          recordButton.value = "‚è≥ Finalizing clickie (may take >1 min)...";
          statusLabel.textContent = "Encoding video & compressing states. Please wait...";
          
          await capturer.stopRecording();
          
          recordButton.disabled = false;
          recordButton.value = "üî¥ Start Recording Another Clip";
          statusLabel.textContent = "Clickie saved! Ready for next.";
          console.log("Recording stopped and clickie finalized.");
          
        } else {
          // STARTING
          statusLabel.textContent = "Recording... (Click screen to capture mouse)";
          await capturer.startRecording();
          recordButton.value = "‚èπ Stop Recording";
          recordButton.classList.add("recording");
        }
      });
    });
  };
</script>

<div id="browser-warning">
    <strong>‚ö†Ô∏è Browser Compatibility Warning:</strong> This application requires the 
    <code>window.showDirectoryPicker</code> API (File System Access), which is not supported in your current browser. 
    <br>
    Please use a desktop version of <strong>Chrome, Edge, or Opera</strong>.
    <br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker" target="_blank">Learn more at MDN</a>.
</div>

<h1>Album Capturer</h1>

<div id="instructions">
    <h3>Instructions & Tips</h3>
    <ul>
        <li><strong>Step 1:</strong> Click <em>"Create/Open Album Folder"</em> to select an empty folder for your recordings.</li>
        <li><strong>Step 2:</strong> Click <em>"Start Recording Clip"</em> to begin capturing video, inputs, and machine states.</li>
        <li><strong>Step 3:</strong> Interact with the VM! Click the screen to lock your mouse. Press <strong>ESC</strong> to unlock.</li>
        <li><strong>Step 4:</strong> Click <em>"Stop Recording"</em> when finished.</li>
        <li><strong>‚ö†Ô∏è Note:</strong> Finalizing a clip involves heavy compression. It <strong>may take over a minute</strong> for long clips. The browser might freeze briefly.</li>
    </ul>
</div>

<div id="player-wrapper">
    <div id="screen_container">
        <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
        <canvas id="emulator-canvas" style="display: none"></canvas>
    </div>
</div>

<div id="controls">
  <input id="save" type="button" value="üìÇ Create/Open Album Folder" />
  <input id="record" type="button" value="üî¥ Start Recording Clip" disabled />
  
  <label style="font-weight: bold; color: #555; margin-left: 10px;">Scale:</label>
  <input id="scaleInput" type="number" value="80" min="10" max="200" style="width: 50px; padding: 5px; border-radius: 5px; border: 1px solid #ccc;" />
  <span style="color: #555;">%</span>

  <span id="status">Waiting for emulator...</span>
</div>

<script>
    // Check for File System Access API support
    if (!('showDirectoryPicker' in window)) {
        document.getElementById('browser-warning').style.display = 'block';
    }
</script>

</body>
</html>