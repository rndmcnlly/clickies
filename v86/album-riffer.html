<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Album Riffer</title>

    <link rel="stylesheet" href="album-style.css">

    <script src="libv86.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@3.1.1/dist.umd/msgpack.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fast-json-patch@3.1.1/dist/fast-json-patch.min.js"></script>

    <script src="../savestreams_updated.js"></script>
</head>
<body>

<script>
    "use strict";

    window.onload = function () {
        let manifest = {};
        let dirHandle;
        let subDirHandle;
        let savestreamBuffer = null;
        let currentVideoStateIndex = -1;
        let isEmulatorActive = false;

        // UI Elements
        const loadButton = document.getElementById("loadAlbumButton");
        const dropdown = document.getElementById("manifestDropdown");
        const videoPlayer = document.getElementById("responseVideo");
        const track = document.getElementById("stimulusTrack");
        const displayElement = document.getElementById("statusDisplay");
        const screenContainer = document.getElementById("screen_container");
        const interactionBtn = document.getElementById("interactionBtn");
        const stimulusContent = document.getElementById("stimulusContent");

        // Resizing Logic
        const scaleInput = document.getElementById("scaleInput");
        const playerWrapper = document.getElementById("player-wrapper");

        scaleInput.addEventListener("input", () => {
            // Clamp value between 50 and 100
            let val = parseInt(scaleInput.value);
            if (val < 50) val = 50;
            if (val > 100) val = 100;
            
            playerWrapper.style.width = val + "%";
        });

        let emulator = null;

        // --- 1. Initialize Emulator ---
        async function createEmulator() {
            if (emulator) emulator.destroy();

            const machine_spec = structuredClone(manifest.machine_spec);
            machine_spec.screen_container = screenContainer;

            emulator = window.emulator = new V86(machine_spec);

            screenContainer.addEventListener("click", () => {
                if (emulator && isEmulatorActive) {
                    emulator.lock_mouse();
                }
            });
        }

        // --- 2. Load Album ---
        loadButton.addEventListener('click', async () => {
            loadButton.blur();
            try {
                dirHandle = await window.showDirectoryPicker();
                let handle = await dirHandle.getFileHandle("manifest.json");
                let manifestFile = await handle.getFile();
                manifest = JSON.parse(await manifestFile.text());

                await createEmulator();

                dropdown.innerHTML = '<option disabled selected>Choose clip</option>';
                if (manifest.clips && manifest.clips.length > 0) {
                    for (let clip of manifest.clips) {
                        const option = document.createElement("option");
                        option.textContent = clip["id"];
                        dropdown.appendChild(option);
                    }
                    dropdown.value = manifest.clips[0].id;
                    loadButton.value = "üìÇ Album Loaded";
                    loadButton.disabled = true;
                    await loadClip(manifest.clips[0].id);
                }
            } catch (err) {
                console.error("Error loading album:", err);
                alert("Could not load album. Check console.");
            }
        });

        dropdown.addEventListener("change", async function () {
            this.blur();
            await loadClip(this.value);
        });

        // --- 3. Load Clip Assets ---
        async function loadClip(selectedFolderName) {
            try {
                switchToVideoMode(false);
                savestreamBuffer = null;
                currentVideoStateIndex = -1;
                displayElement.textContent = "Loading media...";
                stimulusContent.textContent = "Loading VTT...";

                subDirHandle = await dirHandle.getDirectoryHandle(selectedFolderName);

                // Load Video
                const videoHandle = await subDirHandle.getFileHandle("response.webm");
                const videoFile = await videoHandle.getFile();
                videoPlayer.src = URL.createObjectURL(videoFile);

                // Load Stimulus (Subtitles)
                try {
                    const stimHandle = await subDirHandle.getFileHandle("stimulus.vtt");
                    const stimFile = await stimHandle.getFile();

                    track.src = URL.createObjectURL(stimFile);
                    track.default = true;

                    const vttText = await stimFile.text();
                    stimulusContent.textContent = vttText;

                } catch {
                    console.warn("stimulus.vtt not found");
                    track.removeAttribute("src");
                    stimulusContent.textContent = "No stimulus.vtt found.";
                }

                // Load Savestream
                try {
                    const ssHandle = await subDirHandle.getFileHandle("states.savestream");
                    const ssFile = await ssHandle.getFile();
                    savestreamBuffer = new Uint8Array(await ssFile.arrayBuffer());
                    console.log(`Loaded savestream (${savestreamBuffer.byteLength} bytes)`);

                    interactionBtn.disabled = false;
                    displayElement.textContent = "Ready.";
                } catch {
                    console.warn("states.savestream not found");
                    displayElement.textContent = "Read-only (No savestream found)";
                    interactionBtn.disabled = true;
                }

                // Show subtitles and play
                videoPlayer.textTracks[0].mode = "showing";
                await videoPlayer.play();

            } catch (err) {
                console.error("Failed to load clip:", err);
            }
        }

        // --- 4. Sync Video Time to State Index ---
        videoPlayer.addEventListener("timeupdate", () => {
            if (!savestreamBuffer || isEmulatorActive) return;

            const currentTime = videoPlayer.currentTime;
            const activeCues = track.track.cues;

            if (!activeCues || activeCues.length === 0) return;

            let foundIndex = -1;
            for (let i = activeCues.length - 1; i >= 0; i--) {
                const cue = activeCues[i];
                if (cue.startTime <= currentTime) {
                    try {
                        const data = JSON.parse(cue.text);
                        if (data.event && data.event.name === "save-state") {
                            foundIndex = data.event.index;
                            break;
                        }
                    } catch (e) { }
                }
            }

            currentVideoStateIndex = foundIndex;

            if (currentVideoStateIndex > -1) {
                displayElement.textContent = `Sync: State #${currentVideoStateIndex} available at ${currentTime.toFixed(2)}s`;
            } else {
                displayElement.textContent = "Waiting for first state...";
            }
        });

        // --- 5. Toggle Interaction Mode ---
        interactionBtn.addEventListener("click", async () => {
            interactionBtn.blur();
            if (isEmulatorActive) {
                switchToVideoMode(true); // Play on return
            } else {
                switchToEmulatorMode();
            }
        });

        async function switchToEmulatorMode() {
            if (currentVideoStateIndex === -1) {
                alert("No state available yet. Wait for the video to play a bit further.");
                return;
            }

            // Pause Video
            videoPlayer.pause();
            displayElement.textContent = `Restoring state #${currentVideoStateIndex}...`;
            interactionBtn.disabled = true;

            try {
                const stateBuffer = await window.v86Savestream.decodeOne(savestreamBuffer, currentVideoStateIndex);
                await emulator.restore_state(stateBuffer);

                videoPlayer.classList.add("hidden");
                screenContainer.classList.add("active");
                playerWrapper.classList.add("riffing");

                isEmulatorActive = true;
                interactionBtn.textContent = "‚Ü©Ô∏è Return to Video";
                interactionBtn.classList.add("return-mode");
                interactionBtn.disabled = false;

                emulator.run();
                emulator.lock_mouse();
                displayElement.textContent = "Interactive Mode Active. (Mouse locked)";

            } catch (err) {
                console.error("Restore failed:", err);
                alert("Failed to restore emulator state.");
                switchToVideoMode(true);
            }
        }

        function switchToVideoMode(autoPlay = false) {
            if (emulator) emulator.stop();

            screenContainer.classList.remove("active");
            playerWrapper.classList.remove("riffing");
            videoPlayer.classList.remove("hidden");

            interactionBtn.textContent = "üëã Take Control";
            interactionBtn.classList.remove("return-mode");
            interactionBtn.disabled = false;

            isEmulatorActive = false;
            displayElement.textContent = "Video Mode";

            if (autoPlay) {
                videoPlayer.play();
            }
        }
    }
</script>

<div id="browser-warning">
    <strong>‚ö†Ô∏è Browser Compatibility Warning:</strong> This application requires the
    <code>window.showDirectoryPicker</code> API (File System Access), which is not supported in your current browser.
    <br>
    Please use a desktop version of <strong>Chrome, Edge, or Opera</strong>.
    <br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/showDirectoryPicker" target="_blank">Learn more at
        MDN</a>.
</div>

<h1>Album Riffer</h1>

<div id="instructions">
    <h3>How to Riff</h3>
    <ul>
        <li><strong>Step 1:</strong> Click <em>"Load Album Folder"</em> to load a recorded album.</li>
        <li><strong>Step 2:</strong> Use the dropdown to select a specific clickie within the album.</li>
        <li><strong>Step 3:</strong> Watch the video! You'll see inputs and state events in the subtitles.</li>
        <li><strong>Step 4:</strong> See something interesting? Click <strong>"üëã Take Control"</strong>.</li>
        <li><strong>Step 5:</strong> The video will pause, and the emulator will take over after a brief delay.
            The mouse will be automatically locked to the emulator. (ESC to unlock)</li>
        <li><strong>Step 6:</strong> When done experimenting, click <strong>"‚Ü©Ô∏è Return to Video"</strong> to resume
            playback.</li>
    </ul>
</div>

<div id="player-wrapper">
    <video id="responseVideo" type="video/webm" controls controlsList="nofullscreen nodownload noremoteplayback"
        disablePictureInPicture>
        <track id="stimulusTrack" kind="subtitles" default>
    </video>

    <div id="screen_container">
        <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
        <canvas style="display: none"></canvas>
    </div>
</div>

<div id="controls">
    <input id="loadAlbumButton" type="button" value="üìÇ Load Album Folder">
    <select id="manifestDropdown">
        <option disabled selected>Choose clip</option>
    </select>

    <div style="flex-grow: 1;"></div> <button id="interactionBtn" disabled>üëã Take Control</button>

    <label style="font-weight: bold; color: #555; margin-left: 10px;">Size:</label>
    <input id="scaleInput" type="number" value="85" min="50" max="100"
        style="width: 50px; padding: 5px; border-radius: 5px; border: 1px solid #ccc;" />
    <span style="color: #555;">%</span>
</div>

<div id="debug-section">
    <details>
        <summary>‚öôÔ∏è Developer Menu & Logs</summary>
        <div id="statusDisplay">System Status: Waiting for album...</div>
        <strong>Raw Stimulus Track (VTT):</strong>
        <pre id="stimulusContent">No data loaded.</pre>
    </details>
</div>

<script>
    // Check for File System Access API support
    if (!('showDirectoryPicker' in window)) {
        document.getElementById('browser-warning').style.display = 'block';
    }
</script>

</body>
</html>